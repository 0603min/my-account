<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 é›²ç«¯è¨˜å¸³æœ¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="p-5">
    <canvas id="bgCanvas" style="position:fixed; top:0; left:0; z-index:-1; pointer-events:none;"></canvas>
    <div class="loading-bar" id="loadingBar"></div>
    
    <!-- æ·±è‰²æ¨¡å¼åˆ‡æ›æŒ‰éˆ• -->
    <button class="theme-toggle" onclick="toggleTheme()" id="themeToggle">
        ğŸŒ™
    </button>

    <div class="max-w-md mx-auto">
        <h1 class="text-3xl font-bold mb-8 text-center gradient-text">ğŸ’° 2026 ç²¾ç·»è¨˜å¸³</h1>

        <!-- é¤˜é¡å¡ç‰‡ -->
        <div class="glass-ui p-8 mb-6 text-center">
            <p class="text-secondary-custom text-sm mb-2">ç›®å‰é¤˜é¡</p>
            <h2 id="balance" class="text-5xl font-bold text-primary-custom balance-animate">$ 0</h2>
        </div>

        <!-- è¼¸å…¥è¡¨å–® -->
        <div class="glass-ui p-6 mb-8 space-y-4">
            <input id="desc" type="text" placeholder="âœï¸ é …ç›®å…§å®¹" class="input-style">
            
            <input id="amt" type="number" placeholder="ğŸ’µ é‡‘é¡" class="input-style">
            
            <div>
                <label class="text-xs text-secondary-custom ml-2 mb-1 block">â° ç™¼ç”Ÿæ™‚é–“</label>
                <input id="time" type="datetime-local" class="input-style">
            </div>

            <div class="flex gap-3 pt-2">
                <button onclick="sendData('income')" class="flex-1 bg-emerald-500 text-white py-4 rounded-2xl font-bold text-lg btn-primary">
                    âœ¨ å­˜å…¥
                </button>
                <button onclick="sendData('expense')" class="flex-1 bg-gradient-to-r from-slate-700 to-slate-900 text-white py-4 rounded-2xl font-bold text-lg btn-primary">
                    ğŸ’¸ æ”¯å‡º
                </button>
            </div>
        </div>

        <!-- è¨˜éŒ„åˆ—è¡¨ -->
        <div id="list" class="space-y-3"></div>
    </div>

    <script>
        const API = 'https://script.google.com/macros/s/AKfycbzLAWeTRW4efS5NHRXrYD9Hd5qZGsBeV7U6IMRf-EOxLPP9IO4cVPjpSzyGntwRjwd1eg/exec'; // <--- è«‹æ›ä¸Šä½ çš„ç¶²å€

        // åˆå§‹åŒ–ä¸»é¡Œ
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
        }

        // åˆ‡æ›ä¸»é¡Œ
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
        }

        // æ›´æ–°ä¸»é¡Œåœ–ç¤º
        function updateThemeIcon(theme) {
            document.getElementById('themeToggle').innerText = theme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
        }

        // é é¢é–‹å•Ÿæ™‚åšä¸‰ä»¶äº‹ï¼šåˆå§‹åŒ–ä¸»é¡Œã€è¨­å®šé è¨­æ™‚é–“ã€æŠ“è³‡æ–™
        window.onload = () => {
            initTheme();
            setDefaultTime();
            fetchData();
        };

        // è¨­å®šã€Œç•¶ä¸‹æ™‚é–“ã€åˆ°è¼¸å…¥æ¡†
        function setDefaultTime() {
            const now = new Date();
            const offset = now.getTimezoneOffset() * 60000;
            const localISOTime = (new Date(now - offset)).toISOString().slice(0, 16);
            document.getElementById('time').value = localISOTime;
        }

        async function fetchData() {
            showLoading(true);
            try {
                const res = await fetch(API);
                const data = await res.json();
                let b = 0;
                document.getElementById('list').innerHTML = data.reverse().map((i, index) => {
                    const isInc = i.type === 'income';
                    b += isInc ? Number(i.amount) : -Number(i.amount);
                    const dateObj = new Date(i.date);
                    const timeStr = dateObj.toLocaleDateString() + ' ' + dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    return `
                        <div class="glass-ui p-5 flex justify-between items-center list-item" style="animation-delay: ${index * 0.05}s">
                            <div>
                                <p class="font-bold text-primary-custom text-lg">${i.desc}</p>
                                <p class="text-xs text-secondary-custom mt-1">ğŸ“… ${timeStr}</p>
                            </div>
                            <span class="${isInc?'text-emerald-500':'text-rose-500'} font-bold text-xl">
                                ${isInc?'+':'-'}$${Number(i.amount).toLocaleString()}
                            </span>
                        </div>`;
                }).join('');
                
                const balanceEl = document.getElementById('balance');
                balanceEl.innerText = `$ ${b.toLocaleString()}`;
                balanceEl.classList.add('balance-animate');
                setTimeout(() => balanceEl.classList.remove('balance-animate'), 500);
            } catch (error) {
                console.error('è¼‰å…¥å¤±æ•—:', error);
            }
            showLoading(false);
        }

        async function sendData(type) {
            const desc = document.getElementById('desc').value;
            const amount = document.getElementById('amt').value;
            const time = document.getElementById('time').value;

            if(!desc || !amount || !time) {
                alert('è«‹å®Œæ•´å¡«å¯«è³‡è¨Š ğŸ“');
                return;
            }

            showLoading(true);
            
            try {
                await fetch(API, { 
                    method: 'POST', 
                    body: JSON.stringify({ 
                        desc: desc, 
                        amount: Number(amount), 
                        type: type,
                        customDate: time
                    }) 
                });
                
                location.reload();
            } catch (error) {
                console.error('é€å‡ºå¤±æ•—:', error);
                showLoading(false);
            }
        }

        // è¼‰å…¥é€²åº¦æ¢
        function showLoading(show) {
            const bar = document.getElementById('loadingBar');
            if (show) {
                bar.style.width = '70%';
                document.body.style.opacity = '0.7';
            } else {
                bar.style.width = '100%';
                setTimeout(() => {
                    bar.style.width = '0';
                    document.body.style.opacity = '1';
                }, 300);
            }
        }
    </script>
</body>
</html>